This document describe how to use a script to setup AWS CloudTrail services to audit API calls. 

Although CloudTrail configuration can be setup on AWS console, we use a script to ensure naming schema consistency cross
all regions. All AWS services (Cloudtrail, SNS, SQS) created will have a prefix __'accountId-'__

## Install AWSCLI and Jq

  [AWSCLI] (https://github.com/aws/aws-cli) command line tool is used to create Cloudtrail. To install (or upgrade) the package:

```
$ brew install awscli jq
```

   This will install _aws_ command under /usr/local/bin. There are three ways to setup AWS CLI AWS credentials. The examples here assumes you run the Cloudtrail creation code on an on-premise system and use a configuration file for key id and key secret. If you run it on EC2, you need to create an IAM role and Ã¥the aws cli can use role-based token automatically.
    
   To configure AWSCLI with an IAM user that can create CloudTrail, SNS, SQS, and S3 bucket services
    
```
$ aws --profile <profile> configure
```

   The above command will generate two files, for example:
   
```
$ cat /etc/.aws/awscli.conf
# For AWS CLI
[profile mylab-cloudtrail]
region = us-west-2
...

$cat /etc/.aws/credentials
[mylab-cloudtrail]
aws_access_key_id = <key id>
aws_secret_access_key = <secrect>
```

## Quick start: Create AWS CloudTrail

The script will setup CloutTrail for all currently supported regions. You can modify the script to suit your need. These are the [current supported regions](http://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-supported-regions.html):

* us-east-1
* us-west-1
* us-west-2
* eu-west-1
* sa-east-1
* ap-northeast-1
* ap-southeast-1	
* ap-southeast-2

To enable CloudTrail on these regions, download and run [cloudtrail-admnin.sh](./scripts/cloudtrail-admin.sh). This script calls awscli cloudtrail command to create or destroy cloudtrail setup. For setup, it performs the following functinons:

* Turn on Cloudtrail service in all supported region to send reports to *s3://`<accountId`>-cloudtrail* S3 bucket
* Create trail with name *s3://`<accountId>`-cloudtrail-`<region>`*
* Create Simple Notification Service (SNS) topic for the Cloudtrail service in each region
* (Optional) Create *`<accountId>`-cloudtrail* SQS in one region to receive CloudTrail report notification. You only need this for Splunk.
  
All CloudTrails reports are sent into one S3 bucket default to *s3://`<accountId`>-cloudtrail*. Global events - generated by global services such as Identity and Access Management (IAM) - will be logged in the trail in the region given at the command line.

For help:

```
$ ./cloudtrail-admin.sh -h
create-cloudtrail -a <action> -p <profile> [-b <bucket>] -r region [-n] [-y]

 -a <create|show|delete>: action. create, show or delete cloudtrails setup by this tool.
 -p <aws profile>: authenticate as this profile.
 -b <bucket>: optional. bucket name to get all trail reports.
 -r <region>: region to get AWS global events, e.g. IAM
 -y     : non-interative mode. Answer to yes to all default values.
 -n     : dryrun. print out the commands
 -h     : Help
```

To create Cloudtrails, SNS and SQS:

```
./cloudtrail-admin.sh -a create -p <aws profile> -r <region to receive global event>
```

To show Cloudtrails, SNS and SQS:

```
./cloudtrail-admin.sh -a show -p <aws profile>
```

To tear down the resources created:
```
./cloudtrail-admin.sh -a delete -p  <aws profile> -r <region to receive global event>
```

NOTE: The Cloudtrail bucket will not be deleted since it may contain past audit logs. 

The cloudtrail now is enabled and you can go to AWS CloudTrail service console to view logs or through API calls. 


## Third party visualized reporting tools
Many tools are available to generate visualized reports using the CloudTrail files stored in S3 bucket. Here are listed 
[AWS partners](http://aws.amazon.com/cloudtrail/partners/). This documentation describes how to use [SplunkAppforAWS](http://apps.splunk.com/app/1274/) to consume Cloudtrail data and generate reports. 

Here is an example of [Splunk Integration](https://github.com/xueshanf/aws-cloudtrail-with-splunk/scripts/). 

